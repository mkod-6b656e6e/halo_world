Skip to content
This repository
Search
Pull requests
Issues
Gist
 @mkod1130
 Watch 0
  Star 0
  Fork 0 yvonnelimyx/whowantslunchlater
 Code  Issues 0  Pull requests 0  Projects 0  Wiki  Pulse  Graphs
Branch: master Find file Copy pathwhowantslunchlater/routes/index.js
bfc0b29  4 minutes ago
 yvonne secnd commit
0 contributors
RawBlameHistory     
62 lines (48 sloc)  1.34 KB
var express = require('express');
var router = express.Router();

/* GET home page. */

//verification code
router.get('/', function(req, res, next) {
  res.render('index', { title: 'Express' });
});

router.get('/webhook', function(req, res) {

 if (req.query['hub.verify_token'] === 'tokenvon') {
   res.send(req.query['hub.challenge']);
 } else {
   res.send('Error, wrong validation token');
 }
});

//recievemessage
router.post('/webhook/', function (req, res) {
 const events = req.body.entry[0].messaging;
 for (i = 0; i < events.length; i++) {
   const event = req.body.entry[0].messaging[i];
   if (event.message && event.message.text) {
     const text = event.message.text;
     console.log(text)
   	 sendTextMessage(sender, "Text received, echo: " + text);
   }
 }

 res.sendStatus(200);

});

//POST message 
var request = require('request')

const ACCESS_TOKEN = process.env.FB_ACCESS_TOKEN


function sendTextMessage(sender, text) {
 request({
   url: 'https://graph.facebook.com/v2.6/me/messages',
   qs: {access_token: ACCESS_TOKEN},
   method: 'POST',
   json: {
     recipient: {id: sender},
     message: {text: text}
   }

 }, function(error, response, body) {
   if (error) {
     console.log('Error sending message: ', error);
   } else if (response.body.error) {
     console.log('Error: ', response.body.error);
   }
 });
}

module.exports = router;

